<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Precios</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Meta tags for PWA -->
    <meta name="theme-color" content="#374151"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192x192.png">

    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* NEW: CSS Variables for Theming */
        :root, [data-theme='claro'] {
            --color-bg: #f3f4f6; /* gray-100 */
            --color-surface: #ffffff; /* white */
            --color-surface-secondary: #f9fafb; /* gray-50 */
            --color-accent: #3b82f6; /* blue-500 */
            --color-accent-text: #ffffff; /* white */
            --color-text-primary: #1f2937; /* gray-800 */
            --color-text-secondary: #6b7280; /* gray-500 */
            --color-border: #e5e7eb; /* gray-200 */
            --color-header-border: #e5e7eb; /* gray-200 */
        }
        [data-theme='oscuro'] {
            --color-bg: #111827; /* gray-900 */
            --color-surface: #1f2937; /* gray-800 */
            --color-surface-secondary: #374151; /* gray-700 */
            --color-accent: #60a5fa; /* blue-400 */
            --color-accent-text: #111827; /* gray-900 */
            --color-text-primary: #f9fafb; /* gray-50 */
            --color-text-secondary: #9ca3af; /* gray-400 */
            --color-border: #4b5563; /* gray-600 */
            --color-header-border: #374151; /* gray-700 */
        }
        [data-theme='moderno'] {
            --color-bg: #4b5563; /* gray-600 */
            --color-surface: #374151; /* gray-700 */
            --color-surface-secondary: #4b5563; /* gray-600 */
            --color-accent: #10b981; /* green-500 */
            --color-accent-text: #ffffff; /* white */
            --color-text-primary: #ffffff; /* white */
            --color-text-secondary: #d1d5db; /* gray-300 */
            --color-border: #9ca3af; /* gray-400 */
            --color-header-border: #10b981; /* green-500 */
        }
        [data-theme='corporativo'] {
            --color-bg: #1e3a8a; /* blue-900 */
            --color-surface: #1d4ed8; /* blue-700 */
            --color-surface-secondary: #2563eb; /* blue-600 */
            --color-accent: #facc15; /* yellow-400 */
            --color-accent-text: #000000; /* black */
            --color-text-primary: #ffffff; /* white */
            --color-text-secondary: #dbeafe; /* blue-200 */
            --color-border: #3b82f6; /* blue-500 */
            --color-header-border: #facc15; /* yellow-400 */
        }

        /* Other styles */
        .transition-all { transition: all 0.3s ease-in-out; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .loader { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
    
    <!-- NEW: Tailwind config using CSS variables -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Kept for compatibility if needed, but we use data-theme
            theme: {
                extend: {
                    colors: {
                        'theme-bg': 'var(--color-bg)',
                        'theme-surface': 'var(--color-surface)',
                        'theme-surface-secondary': 'var(--color-surface-secondary)',
                        'theme-accent': 'var(--color-accent)',
                        'theme-accent-text': 'var(--color-accent-text)',
                        'theme-text-primary': 'var(--color-text-primary)',
                        'theme-text-secondary': 'var(--color-text-secondary)',
                        'theme-border': 'var(--color-border)',
                        'theme-header-border': 'var(--color-header-border)',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-theme-bg text-theme-text-primary transition-colors duration-300">

    <!-- Main App Container -->
    <div id="app" class="max-w-7xl mx-auto">

        <!-- Header -->
        <header class="bg-theme-surface shadow-md p-4 sticky top-0 z-20 flex justify-between items-center border-b-2 border-theme-header-border">
            <div class="w-10"></div> <!-- Spacer -->
            <h1 id="header-title" class="text-2xl font-bold text-theme-text-primary text-center">Catálogo de Precios</h1>
            <!-- NEW: Theme Selector Dropdown -->
            <div id="theme-selector" class="relative">
                <button id="theme-menu-button" class="p-2 rounded-full text-theme-text-secondary hover:bg-theme-bg focus:outline-none">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a4 4 0 014-4h10a4 4 0 014 4v12a4 4 0 01-4 4H7z"></path></svg>
                </button>
                <div id="theme-menu" class="hidden absolute right-0 mt-2 w-40 bg-theme-surface rounded-md shadow-lg z-30 border border-theme-border">
                    <a href="#" class="block px-4 py-2 text-sm text-theme-text-primary hover:bg-theme-bg" data-theme="claro">Claro</a>
                    <a href="#" class="block px-4 py-2 text-sm text-theme-text-primary hover:bg-theme-bg" data-theme="oscuro">Oscuro</a>
                    <a href="#" class="block px-4 py-2 text-sm text-theme-text-primary hover:bg-theme-bg" data-theme="moderno">Moderno</a>
                    <a href="#" class="block px-4 py-2 text-sm text-theme-text-primary hover:bg-theme-bg" data-theme="corporativo">Corporativo</a>
                </div>
            </div>
        </header>

        <!-- Loading Spinner -->
        <div id="loader" class="flex justify-center items-center h-screen">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
        </div>

        <!-- Error Message Display -->
        <div id="error-message" class="hidden text-center p-8"></div>

        <!-- Store Selector -->
        <div id="store-selector-container" class="p-4 md:p-8 text-center">
            <h2 class="text-xl font-semibold mb-4">Selecciona una tienda</h2>
            <div id="store-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
        </div>

        <!-- Catalog View (hidden by default) -->
        <div id="catalog-container" class="hidden">
             <div class="p-4">
                <button id="back-to-stores" class="bg-theme-text-secondary text-theme-bg font-bold py-2 px-4 rounded-lg transition-all">
                    &larr; Cambiar de tienda
                </button>
            </div>
            <div id="filters-container" class="p-4 bg-theme-surface shadow-sm sticky top-[88px] md:top-[80px] z-10 grid grid-cols-1 sm:grid-cols-3 gap-4">
                <select id="filter-menu" class="w-full p-2 border border-theme-border rounded-lg bg-theme-surface text-theme-text-primary focus:ring-2 focus:ring-theme-accent"></select>
                <select id="filter-tipo" class="w-full p-2 border border-theme-border rounded-lg bg-theme-surface text-theme-text-primary focus:ring-2 focus:ring-theme-accent"></select>
                <select id="filter-pres" class="w-full p-2 border border-theme-border rounded-lg bg-theme-surface text-theme-text-primary focus:ring-2 focus:ring-theme-accent"></select>
            </div>
            <div id="product-list" class="p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
             <div id="no-results" class="hidden text-center p-8">
                <p class="text-theme-text-secondary font-semibold text-lg">No se encontraron productos.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = "https://script.google.com/macros/s/AKfycbyCeUfSV8KNH8J1DHvce1R48OROY_BjkBlE-7m50q-J-Xd29xvQnvKCM0mJf2zcgNDkog/exec";

            // DOM Elements
            const loader = document.getElementById('loader');
            const errorMessage = document.getElementById('error-message');
            const storeSelectorContainer = document.getElementById('store-selector-container');
            const storeList = document.getElementById('store-list');
            const catalogContainer = document.getElementById('catalog-container');
            const productList = document.getElementById('product-list');
            const noResults = document.getElementById('no-results');
            const headerTitle = document.getElementById('header-title');
            const backToStoresBtn = document.getElementById('back-to-stores');
            const themeMenuButton = document.getElementById('theme-menu-button');
            const themeMenu = document.getElementById('theme-menu');

            // Filters
            const filterMenu = document.getElementById('filter-menu');
            const filterTipo = document.getElementById('filter-tipo');
            const filterPres = document.getElementById('filter-pres');

            // App State
            let allData = [];
            let currentStoreProducts = [];
            let currentStore = '';
            
            // --- Theme Management ---
            function applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            }

            themeMenuButton.addEventListener('click', (event) => {
                event.stopPropagation();
                themeMenu.classList.toggle('hidden');
            });

            document.addEventListener('click', () => {
                if (!themeMenu.classList.contains('hidden')) {
                    themeMenu.classList.add('hidden');
                }
            });

            themeMenu.addEventListener('click', (event) => {
                event.preventDefault();
                const selectedTheme = event.target.dataset.theme;
                if (selectedTheme) {
                    applyTheme(selectedTheme);
                }
            });

            function initializeTheme() {
                const savedTheme = localStorage.getItem('theme') || 'claro';
                applyTheme(savedTheme);
            }


            // --- Data Fetching ---
            async function fetchData() {
                loader.style.display = 'flex';
                catalogContainer.style.display = 'none';
                storeSelectorContainer.style.display = 'none';
                errorMessage.style.display = 'none';
                try {
                    const response = await fetch(API_URL);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const responseData = await response.json();
                    
                    if (responseData && Array.isArray(responseData.data)) allData = responseData.data;
                    else if (Array.isArray(responseData)) allData = responseData;
                    else throw new Error("La respuesta de la API no tiene el formato esperado.");

                    renderStoreSelector();
                } catch (error) {
                    console.error("Failed to fetch data:", error);
                    errorMessage.innerHTML = `<p class="text-red-500 font-semibold">Error al cargar datos.</p>`;
                    errorMessage.style.display = 'block';
                } finally {
                    loader.style.display = 'none';
                }
            }

            // --- Rendering Functions ---
            function renderStoreSelector() {
                if (!Array.isArray(allData)) {
                    errorMessage.innerHTML = `<p class="text-red-500 font-semibold">Error: Datos no válidos.</p>`;
                    errorMessage.style.display = 'block';
                    return;
                }
                
                const stores = [...new Set(allData.map(item => item.Tienda))].filter(Boolean); 
                storeList.innerHTML = ''; 

                if (stores.length === 0) {
                    errorMessage.innerHTML = `<p class="text-yellow-600 font-semibold">No se encontraron tiendas.</p>`;
                    errorMessage.style.display = 'block';
                    storeSelectorContainer.style.display = 'none';
                    return;
                }

                stores.forEach(store => {
                    const button = document.createElement('button');
                    button.className = "bg-theme-surface p-6 rounded-lg shadow-md hover:shadow-xl hover:-translate-y-1 transition-all text-lg font-semibold text-theme-text-primary";
                    button.textContent = store;
                    button.addEventListener('click', () => selectStore(store));
                    storeList.appendChild(button);
                });
                storeSelectorContainer.style.display = 'block';
            }

            function renderProducts() {
                const filters = {
                    Menu: filterMenu.value,
                    Tipo: filterTipo.value,
                    Pres: filterPres.value
                };

                let filteredByMenuAndTipo = currentStoreProducts.filter(product => 
                    (filters.Menu === 'all' || product.Menu === filters.Menu) &&
                    (filters.Tipo === 'all' || product.Tipo === filters.Tipo)
                );
                
                productList.innerHTML = ''; 
                noResults.style.display = 'none';

                if (filters.Pres === 'all') {
                    const groupedProducts = filteredByMenuAndTipo.reduce((acc, product) => {
                        const productName = product.Producto;
                        if (!acc[productName]) acc[productName] = [];
                        acc[productName].push(product);
                        return acc;
                    }, {});

                    if (Object.keys(groupedProducts).length === 0) {
                        noResults.style.display = 'block';
                        return;
                    }

                    for (const productName in groupedProducts) {
                        const presentations = groupedProducts[productName];
                        const firstPresentation = presentations[0];
                        const card = document.createElement('div');
                        card.className = "bg-theme-surface rounded-lg shadow-md overflow-hidden flex flex-col";
                        const placeholderImg = `https://placehold.co/400x400/e2e8f0/4a5568?text=${encodeURIComponent(productName)}`;
                        const tableRows = presentations.map(p => {
                            const presValue = p.Pres || p['Pres.'] || p.Presentacion || '';
                            return `<tr class="border-b border-theme-border last:border-b-0">
                                        <td class="py-2 px-3 text-sm text-theme-text-primary">${presValue}</td>
                                        <td class="py-2 px-3 text-sm text-theme-text-secondary line-through text-right">$${Number(p['Precio $']).toFixed(2)}</td>
                                        <td class="py-2 px-3 text-base font-bold text-theme-accent text-right">$${Number(p['Precio $ con Desc']).toFixed(2)}</td>
                                    </tr>`;
                        }).join('');
                        card.innerHTML = `<img src="${firstPresentation.Images || placeholderImg}" alt="${productName}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='${placeholderImg}';">
                                          <div class="p-4 flex flex-col flex-grow">
                                              <h3 class="text-lg font-semibold text-theme-text-primary mb-3">${productName}</h3>
                                              <div class="w-full overflow-x-auto no-scrollbar">
                                                  <table class="min-w-full bg-theme-surface-secondary rounded-lg">
                                                      <thead><tr class="bg-theme-bg"><th class="py-2 px-3 text-left text-xs font-bold uppercase text-theme-text-secondary">Presentación</th><th class="py-2 px-3 text-right text-xs font-bold uppercase text-theme-text-secondary">Precio</th><th class="py-2 px-3 text-right text-xs font-bold uppercase text-theme-text-secondary">Oferta</th></tr></thead>
                                                      <tbody>${tableRows}</tbody>
                                                  </table>
                                              </div>
                                          </div>`;
                        productList.appendChild(card);
                    }
                } else {
                    const filteredProducts = filteredByMenuAndTipo.filter(product => {
                        const presentationValue = product.Pres || product['Pres.'] || product.Presentacion;
                        return presentationValue === filters.Pres;
                    });
                    if (filteredProducts.length === 0) {
                        noResults.style.display = 'block';
                        return;
                    }
                    filteredProducts.forEach(product => {
                        const card = document.createElement('div');
                        card.className = "bg-theme-surface rounded-lg shadow-md overflow-hidden flex flex-col transition-all hover:shadow-lg";
                        const placeholderImg = `https://placehold.co/400x400/e2e8f0/4a5568?text=${encodeURIComponent(product.Producto)}`;
                        const presValue = product.Pres || product['Pres.'] || product.Presentacion || '';
                        card.innerHTML = `<img src="${product.Images || placeholderImg}" alt="${product.Producto}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='${placeholderImg}';">
                                          <div class="p-4 flex flex-col flex-grow">
                                              <h3 class="text-lg font-semibold text-theme-text-primary mb-2 flex-grow">${product.Producto}</h3>
                                              <div class="mt-auto">
                                                  <p class="text-theme-text-secondary font-medium mb-2">${presValue}</p>
                                                  <p class="text-theme-text-secondary text-sm line-through">Precio: $${Number(product['Precio $']).toFixed(2)}</p>
                                                  <p class="text-theme-accent text-xl font-bold">Ahora: $${Number(product['Precio $ con Desc']).toFixed(2)}</p>
                                              </div>
                                          </div>`;
                        productList.appendChild(card);
                    });
                }
            }

            function populateFilters() {
                const menus = ['Todos los Menús', ...new Set(currentStoreProducts.map(p => p.Menu).filter(Boolean))];
                const tipos = ['Todos los Tipos', ...new Set(currentStoreProducts.map(p => p.Tipo).filter(Boolean))];
                const pres = ['Todas las Presentaciones', ...new Set(currentStoreProducts.map(p => p.Pres || p['Pres.'] || p.Presentacion).filter(Boolean))];
                populateSelect(filterMenu, menus);
                populateSelect(filterTipo, tipos);
                populateSelect(filterPres, pres);
                filterMenu.addEventListener('change', renderProducts);
                filterTipo.addEventListener('change', renderProducts);
                filterPres.addEventListener('change', renderProducts);
            }
            
            function populateSelect(selectElement, options) {
                selectElement.innerHTML = '';
                options.forEach((option, index) => {
                    const opt = document.createElement('option');
                    opt.value = index === 0 ? 'all' : option;
                    opt.textContent = option;
                    selectElement.appendChild(opt);
                });
            }

            function selectStore(storeName) {
                currentStore = storeName;
                currentStoreProducts = allData.filter(item => item.Tienda === storeName);
                storeSelectorContainer.style.display = 'none';
                catalogContainer.style.display = 'block';
                headerTitle.textContent = `Catálogo - ${storeName}`;
                populateFilters();
                renderProducts();
                window.scrollTo(0, 0);
            }

            function goBackToStores() {
                catalogContainer.style.display = 'none';
                storeSelectorContainer.style.display = 'block';
                headerTitle.textContent = 'Catálogo de Precios';
                currentStore = '';
                currentStoreProducts = [];
            }

            // --- Initializers ---
            initializeTheme();
            backToStoresBtn.addEventListener('click', goBackToStores);
            fetchData();
        });
    </script>
</body>
</html>
