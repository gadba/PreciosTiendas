<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Precios</title>

    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind configuration using CSS variables -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Kept for compatibility, but we use data-theme
            theme: {
                extend: {
                    colors: {
                        'theme-bg': 'var(--color-bg)',
                        'theme-surface': 'var(--color-surface)',
                        'theme-surface-secondary': 'var(--color-surface-secondary)',
                        'theme-accent': 'var(--color-accent)',
                        'theme-accent-text': 'var(--color-accent-text)',
                        'theme-text-primary': 'var(--color-text-primary)',
                        'theme-text-secondary': 'var(--color-text-secondary)',
                        'theme-border': 'var(--color-border)',
                        'theme-header-border': 'var(--color-header-border)',
                    }
                }
            }
        }
    </script>

    <!-- Meta tags for PWA -->
    <meta name="theme-color" content="#374151"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192x192.png">

    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* CSS Variables for Theming */
        :root, [data-theme='claro'] {
            --color-bg: #f3f4f6; /* gray-100 */
            --color-surface: #ffffff; /* white */
            --color-surface-secondary: #f9fafb; /* gray-50 */
            --color-accent: #3b82f6; /* blue-500 */
            --color-accent-text: #ffffff; /* white */
            --color-text-primary: #1f2937; /* gray-800 */
            --color-text-secondary: #6b7280; /* gray-500 */
            --color-border: #e5e7eb; /* gray-200 */
            --color-header-border: #e5e7eb; /* gray-200 */
        }
        [data-theme='oscuro'] {
            --color-bg: #111827; /* gray-900 */
            --color-surface: #1f2937; /* gray-800 */
            --color-surface-secondary: #374151; /* gray-700 */
            --color-accent: #60a5fa; /* blue-400 */
            --color-accent-text: #111827; /* gray-900 */
            --color-text-primary: #f9fafb; /* gray-50 */
            --color-text-secondary: #9ca3af; /* gray-400 */
            --color-border: #4b5563; /* gray-600 */
            --color-header-border: #374151; /* gray-700 */
        }
        [data-theme='moderno'] {
            --color-bg: #4b5563; /* gray-600 */
            --color-surface: #374151; /* gray-700 */
            --color-surface-secondary: #4b5563; /* gray-600 */
            --color-accent: #10b981; /* green-500 */
            --color-accent-text: #ffffff; /* white */
            --color-text-primary: #ffffff; /* white */
            --color-text-secondary: #d1d5db; /* gray-300 */
            --color-border: #9ca3af; /* gray-400 */
            --color-header-border: #10b981; /* green-500 */
        }
        [data-theme='corporativo'] {
            --color-bg: #1e3a8a; /* blue-900 */
            --color-surface: #1d4ed8; /* blue-700 */
            --color-surface-secondary: #2563eb; /* blue-600 */
            --color-accent: #facc15; /* yellow-400 */
            --color-accent-text: #000000; /* black */
            --color-text-primary: #ffffff; /* white */
            --color-text-secondary: #dbeafe; /* blue-200 */
            --color-border: #3b82f6; /* blue-500 */
            --color-header-border: #facc15; /* yellow-400 */
        }

        /* Other styles */
        body {
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .transition-all { transition: all 0.3s ease-in-out; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .loader { border-top-color: var(--color-accent); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        #cart-panel {
            transition: transform 0.3s ease-in-out;
        }
        #discount-input:disabled {
            background-color: #e5e7eb; /* gray-200 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        [data-theme='oscuro'] #discount-input:disabled {
            background-color: #4b5563; /* gray-600 */
        }
    </style>
    
</head>
<body class="bg-theme-bg text-theme-text-primary transition-colors duration-300">

    <!-- Main App Container -->
    <div id="app" class="max-w-7xl mx-auto">

        <!-- Header -->
        <header class="bg-theme-surface shadow-md p-2 md:p-4 sticky top-0 z-20 flex justify-between items-center gap-2 md:gap-4 border-b-2 border-theme-header-border">
            <div id="header-content" class="flex-shrink-0 flex items-center h-10 min-w-0">
                <h1 id="header-title" class="text-lg md:text-2xl font-bold text-theme-text-primary truncate">Catálogo</h1>
                <img id="header-logo" src="" alt="Logo de la tienda" class="hidden h-full w-auto object-contain">
            </div>
            <div id="search-container" class="flex-grow min-w-0 hidden">
                <input type="search" id="search-bar" placeholder="Buscar producto..." class="w-full p-2 border border-theme-border rounded-lg bg-theme-surface text-theme-text-primary focus:ring-2 focus:ring-theme-accent">
            </div>
            <div class="flex items-center gap-1 md:gap-2 flex-shrink-0">
                <button id="pago-usd-button" class="p-2 rounded-full text-theme-text-secondary hover:bg-theme-bg focus:outline-none">
                    <svg id="pago-usd-icon-locked" class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    <svg id="pago-usd-icon-unlocked" class="h-6 w-6 hidden text-theme-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>
                </button>
                <!-- Special View Button -->
                <button id="special-view-button" class="p-2 rounded-full text-theme-text-secondary hover:bg-theme-bg focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                </button>
                <!-- Cart Button -->
                <button id="cart-button" class="relative p-2 rounded-full text-theme-text-secondary hover:bg-theme-bg focus:outline-none">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span id="cart-badge" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full hidden">0</span>
                </button>
                <div id="theme-selector" class="relative">
                    <button id="theme-menu-button" class="p-2 rounded-full text-theme-text-secondary hover:bg-theme-bg focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536l12.232-12.232z" /></svg>
                    </button>
                    <div id="theme-menu" class="hidden absolute right-0 mt-2 w-40 bg-theme-surface rounded-md shadow-lg z-30 border border-theme-border">
                        <a href="#" class="block px-4 py-2 text-sm text-theme-text-primary hover:bg-theme-bg" data-theme="claro">Claro</a>
                        <a href="#" class="block px-4 py-2 text-sm text-theme-text-primary hover:bg-theme-bg" data-theme="oscuro">Oscuro</a>
                        <a href="#" class="block px-4 py-2 text-sm text-theme-text-primary hover:bg-theme-bg" data-theme="moderno">Moderno</a>
                        <a href="#" class="block px-4 py-2 text-sm text-theme-text-primary hover:bg-theme-bg" data-theme="corporativo">Corporativo</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Loading Spinner -->
        <div id="loader" class="flex justify-center items-center h-screen">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
        </div>

        <!-- Error Message Display -->
        <div id="error-message" class="hidden text-center p-8"></div>

        <!-- Store Selector -->
        <div id="store-selector-container" class="p-4 md:p-8 text-center" style="display: none;">
            <h2 class="text-xl font-semibold mb-4">Selecciona una tienda</h2>
            <div id="store-list" class="flex flex-col items-center gap-4 w-full"></div>
        </div>

        <!-- Catalog View (hidden by default) -->
        <div id="catalog-container" class="hidden">
             <div class="p-4 flex flex-wrap gap-4 items-center">
                 <div class="flex items-center gap-2">
                    <label for="bcv-rate" class="text-sm font-medium text-theme-text-secondary whitespace-nowrap">Tasa BCV:</label>
                    <input type="text" inputmode="decimal" id="bcv-rate" placeholder="0.00" class="w-full md:w-40 p-2 border border-theme-border rounded-lg bg-theme-surface text-theme-text-primary focus:ring-2 focus:ring-theme-accent">
                </div>
             </div>
             <div id="catalog-content" class="hidden">
                 <div id="filters-container" class="p-4 bg-theme-surface shadow-sm sticky top-[76px] md:top-[80px] z-10 grid grid-cols-1 sm:grid-cols-3 gap-4">
                     <select id="filter-menu" class="w-full p-2 border border-theme-border rounded-lg bg-theme-surface text-theme-text-primary focus:ring-2 focus:ring-theme-accent"></select>
                     <select id="filter-tipo" class="w-full p-2 border border-theme-border rounded-lg bg-theme-surface text-theme-text-primary focus:ring-2 focus:ring-theme-accent"></select>
                     <select id="filter-pres" class="w-full p-2 border border-theme-border rounded-lg bg-theme-surface text-theme-text-primary focus:ring-2 focus:ring-theme-accent"></select>
                 </div>
                 <div id="product-list" class="p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
                  <div id="no-results" class="hidden text-center p-8">
                     <p class="text-theme-text-secondary font-semibold text-lg">No se encontraron productos.</p>
                 </div>
             </div>
        </div>
        
        <!-- Special View Container -->
        <div id="special-view-container" class="hidden">
            <div class="p-4 flex flex-wrap gap-4 items-center">
                <button id="back-to-catalog-button" class="bg-theme-text-secondary text-theme-bg font-bold py-2 px-4 rounded-lg transition-all">&larr; Volver al Catálogo</button>
                 <div class="flex items-center gap-2">
                     <label for="bcv-rate-special" class="text-sm font-medium text-theme-text-secondary whitespace-nowrap">Tasa BCV:</label>
                     <input type="text" inputmode="decimal" id="bcv-rate-special" placeholder="0.00" class="w-full md:w-40 p-2 border border-theme-border rounded-lg bg-theme-surface text-theme-text-primary focus:ring-2 focus:ring-theme-accent">
                 </div>
            </div>
            <div id="special-catalog-content" class="hidden">
                <div class="p-4 bg-theme-surface shadow-sm sticky top-[76px] md:top-[80px] z-10 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <select id="filter-tipo-special" class="w-full p-2 border border-theme-border rounded-lg bg-theme-surface text-theme-text-primary focus:ring-2 focus:ring-theme-accent"></select>
                    <select id="filter-pres-special" class="w-full p-2 border border-theme-border rounded-lg bg-theme-surface text-theme-text-primary focus:ring-2 focus:ring-theme-accent"></select>
                </div>
                <div id="special-product-table" class="p-4 space-y-2"></div>
            </div>
        </div>

        <!-- Password Modal -->
        <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4 hidden modal-overlay">
            <div class="bg-theme-surface p-6 rounded-lg shadow-xl w-full max-w-sm">
                <h3 class="text-lg font-bold text-theme-text-primary mb-4">Activar Vista de Pago en $</h3>
                <p id="password-error" class="text-red-500 text-sm mb-2 hidden">Contraseña incorrecta.</p>
                <form id="password-form">
                    <label for="password-input" class="block text-sm font-medium text-theme-text-secondary">Contraseña</label>
                    <input type="password" id="password-input" class="mt-1 w-full p-2 border border-theme-border rounded-lg bg-theme-surface text-theme-text-primary focus:ring-2 focus:ring-theme-accent">
                    <div class="mt-4 flex justify-end gap-4">
                        <button type="button" id="cancel-password" class="px-4 py-2 rounded-lg bg-theme-text-secondary text-theme-bg">Cancelar</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-theme-accent text-theme-accent-text">Activar</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Quantity Modal -->
        <div id="quantity-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4 hidden modal-overlay">
            <div class="bg-theme-surface p-6 rounded-lg shadow-xl w-full max-w-sm">
                <h3 class="text-lg font-bold text-theme-text-primary mb-4">Introducir Cantidad</h3>
                <form id="quantity-form">
                    <label for="quantity-input" class="block text-sm font-medium text-theme-text-secondary">Cantidad</label>
                    <input type="number" id="quantity-input" min="1" value="1" class="mt-1 w-full p-2 border border-theme-border rounded-lg bg-theme-surface text-theme-text-primary focus:ring-2 focus:ring-theme-accent">
                    <div class="mt-4 flex justify-end gap-4">
                        <button type="button" id="cancel-quantity" class="px-4 py-2 rounded-lg bg-theme-text-secondary text-theme-bg">Cancelar</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-theme-accent text-theme-accent-text">Aceptar</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Client Info Modal for Quote -->
        <div id="client-info-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4 hidden modal-overlay">
            <div class="bg-theme-surface p-6 rounded-lg shadow-xl w-full max-w-sm">
                <h3 class="text-lg font-bold text-theme-text-primary mb-4">Datos del Cliente para Cotización</h3>
                <form id="client-info-form" class="space-y-4">
                    <div>
                        <label for="client-name" class="block text-sm font-medium text-theme-text-secondary">Nombre del Cliente</label>
                        <input type="text" id="client-name" required class="mt-1 w-full p-2 border border-theme-border rounded-lg bg-theme-surface text-theme-text-primary focus:ring-2 focus:ring-theme-accent">
                    </div>
                    <div>
                        <label for="client-rif" class="block text-sm font-medium text-theme-text-secondary">RIF</label>
                        <input type="text" id="client-rif" required class="mt-1 w-full p-2 border border-theme-border rounded-lg bg-theme-surface text-theme-text-primary focus:ring-2 focus:ring-theme-accent">
                    </div>
                    <div>
                        <label for="client-phone" class="block text-sm font-medium text-theme-text-secondary">Teléfono</label>
                        <input type="tel" id="client-phone" required class="mt-1 w-full p-2 border border-theme-border rounded-lg bg-theme-surface text-theme-text-primary focus:ring-2 focus:ring-theme-accent">
                    </div>
                    <div>
                        <label for="client-email" class="block text-sm font-medium text-theme-text-secondary">Email</label>
                        <input type="email" id="client-email" required class="mt-1 w-full p-2 border border-theme-border rounded-lg bg-theme-surface text-theme-text-primary focus:ring-2 focus:ring-theme-accent">
                    </div>
                    <div class="mt-6 flex justify-end gap-4">
                        <button type="button" id="cancel-client-info" class="px-4 py-2 rounded-lg bg-theme-text-secondary text-theme-bg">Cancelar</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-theme-accent text-theme-accent-text">Generar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden modal-overlay">
            <div class="bg-theme-surface p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
                <p id="confirmation-message" class="text-lg text-theme-text-primary mb-6">¿Estás seguro?</p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-action" class="px-6 py-2 rounded-lg bg-theme-text-secondary text-theme-bg">No</button>
                    <button id="confirm-action" class="px-6 py-2 rounded-lg bg-red-600 text-white">Sí</button>
                </div>
            </div>
        </div>
        
        <!-- Cart Modal -->
        <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-end hidden modal-overlay">
            <div id="cart-panel" class="w-full max-w-md h-full bg-theme-surface flex flex-col transform translate-x-full">
                <!-- Cart Header -->
                <div class="p-4 flex justify-between items-center border-b border-theme-border flex-shrink-0">
                    <h3 class="text-xl font-bold text-theme-text-primary">Carrito de Compras</h3>
                    <button id="close-cart-button" class="p-2 rounded-full text-theme-text-secondary hover:bg-theme-bg focus:outline-none">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <!-- Cart Items -->
                <div id="cart-items-list" class="flex-grow p-4 overflow-y-auto">
                    <div id="empty-cart-message" class="text-center text-theme-text-secondary mt-10">
                        <p>Tu carrito está vacío.</p>
                    </div>
                </div>
                <!-- Cart Footer -->
                <div id="cart-footer" class="p-4 border-t border-theme-border flex-shrink-0 hidden">
                    <button id="gemini-recipe-btn" class="w-full bg-theme-accent text-theme-accent-text py-2 rounded-lg font-semibold mb-4 flex items-center justify-center gap-2">
                        ✨ Sugerir Receta con IA
                    </button>
                    
                    <!-- Subtotals -->
                    <div class="space-y-1 text-theme-text-secondary">
                        <div class="flex justify-between">
                            <span>Subtotal US$:</span>
                            <span id="cart-subtotal-usd">0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Subtotal Bs.:</span>
                            <span id="cart-subtotal-bs">0.00</span>
                        </div>
                        <div id="cart-subtotal-solo-usd-container" class="hidden flex justify-between font-semibold text-theme-accent">
                            <span>Subtotal SOLO $:</span>
                            <span id="cart-subtotal-solo-usd">0.00</span>
                        </div>
                    </div>

                    <!-- Discount Section -->
                    <div class="mt-4 pt-4 border-t border-theme-border space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="discount-input" class="font-medium text-theme-text-primary">Descuento Global (%):</label>
                            <input type="number" id="discount-input" min="0" max="10" step="0.1" value="0" class="w-24 p-2 border border-theme-border rounded-lg bg-theme-surface text-theme-text-primary text-right focus:ring-2 focus:ring-theme-accent">
                        </div>
                        <div class="flex justify-between text-red-500">
                            <span>Monto Descontado:</span>
                            <span id="discount-amount-display">- 0.00 US$</span>
                        </div>
                    </div>

                    <!-- Final Totals -->
                    <div class="mt-4 pt-4 border-t border-theme-border space-y-2 text-xl font-bold">
                        <div class="flex justify-between text-theme-text-primary">
                            <span>Total US$:</span>
                            <span id="final-total-usd">0.00</span>
                        </div>
                        <div class="flex justify-between text-theme-text-primary">
                            <span>Total Bs.:</span>
                            <span id="final-total-bs">0.00</span>
                        </div>
                         <div id="final-total-solo-usd-container" class="hidden flex justify-between text-theme-accent">
                            <span>Total SOLO $:</span>
                            <span id="final-total-solo-usd">0.00</span>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button id="quote-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold">Cotizar</button>
                        <button id="clear-cart-btn" class="w-full bg-red-600 text-white py-2 rounded-lg font-semibold">Vaciar Carrito</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Gemini AI Modal -->
        <div id="gemini-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden modal-overlay">
            <div class="bg-theme-surface p-6 rounded-lg shadow-xl w-full max-w-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="gemini-modal-title" class="text-lg font-bold text-theme-text-primary">Sugerencia de la IA</h3>
                    <button id="close-gemini-modal" class="p-2 rounded-full text-theme-text-secondary hover:bg-theme-bg focus:outline-none">&times;</button>
                </div>
                <div id="gemini-modal-content" class="text-theme-text-secondary">
                    <!-- Content will be injected here -->
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;
            
            const API_URL = "https://script.google.com/macros/s/AKfycbyCeUfSV8KNH8J1DHvce1R48OROY_BjkBlE-7m50q-J-Xd29xvQnvKCM0mJf2zcgNDkog/exec";
            const storeImageMap = {
                'Manongo': 'https://firebasestorage.googleapis.com/v0/b/catalogo-pinturas.firebasestorage.app/o/LogoManongoRectangular.jpg?alt=media&token=c03a93a6-019f-4210-ac97-1ceac5a92ac2',
                'Sureinca': 'https://firebasestorage.googleapis.com/v0/b/catalogo-pinturas.firebasestorage.app/o/LogoSureincaRectangular.jpg?alt=media&token=4ae21b3c-b7c6-4950-8124-bac3c411f267'
            };

            // DOM Elements
            const loader = document.getElementById('loader');
            const errorMessage = document.getElementById('error-message');
            const storeSelectorContainer = document.getElementById('store-selector-container');
            const storeList = document.getElementById('store-list');
            // Main Catalog View
            const catalogContainer = document.getElementById('catalog-container');
            const catalogContent = document.getElementById('catalog-content');
            const productList = document.getElementById('product-list');
            const noResults = document.getElementById('no-results');
            const bcvRateInput = document.getElementById('bcv-rate');
            const filterMenu = document.getElementById('filter-menu');
            const filterTipo = document.getElementById('filter-tipo');
            const filterPres = document.getElementById('filter-pres');
            // Special View
            const specialViewContainer = document.getElementById('special-view-container');
            const specialCatalogContent = document.getElementById('special-catalog-content');
            const bcvRateInputSpecial = document.getElementById('bcv-rate-special');
            const filterTipoSpecial = document.getElementById('filter-tipo-special');
            const filterPresSpecial = document.getElementById('filter-pres-special');
            const specialProductTable = document.getElementById('special-product-table');
            const backToCatalogButton = document.getElementById('back-to-catalog-button');
            const specialViewButton = document.getElementById('special-view-button');
            // Header & Shared
            const headerContent = document.getElementById('header-content');
            const headerTitle = document.getElementById('header-title');
            const headerLogo = document.getElementById('header-logo');
            const searchContainer = document.getElementById('search-container');
            const searchBar = document.getElementById('search-bar');
            const themeMenuButton = document.getElementById('theme-menu-button');
            const themeMenu = document.getElementById('theme-menu');
            // Password
            const pagoUsdButton = document.getElementById('pago-usd-button');
            const pagoUsdIconLocked = document.getElementById('pago-usd-icon-locked');
            const pagoUsdIconUnlocked = document.getElementById('pago-usd-icon-unlocked');
            const passwordModal = document.getElementById('password-modal');
            const passwordForm = document.getElementById('password-form');
            const passwordInput = document.getElementById('password-input');
            const passwordError = document.getElementById('password-error');
            const cancelPasswordBtn = document.getElementById('cancel-password');
            // Quantity Modal
            const quantityModal = document.getElementById('quantity-modal');
            const quantityForm = document.getElementById('quantity-form');
            const quantityInput = document.getElementById('quantity-input');
            const cancelQuantityBtn = document.getElementById('cancel-quantity');
            // Quote Modals
            const clientInfoModal = document.getElementById('client-info-modal');
            const clientInfoForm = document.getElementById('client-info-form');
            const cancelClientInfoBtn = document.getElementById('cancel-client-info');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationMessage = document.getElementById('confirmation-message');
            const confirmActionBtn = document.getElementById('confirm-action');
            const cancelActionBtn = document.getElementById('cancel-action');
            // Cart
            const cartButton = document.getElementById('cart-button');
            const cartBadge = document.getElementById('cart-badge');
            const cartModal = document.getElementById('cart-modal');
            const cartPanel = document.getElementById('cart-panel');
            const closeCartButton = document.getElementById('close-cart-button');
            const cartItemsList = document.getElementById('cart-items-list');
            const emptyCartMessage = document.getElementById('empty-cart-message');
            const cartFooter = document.getElementById('cart-footer');
            const clearCartBtn = document.getElementById('clear-cart-btn');
            const quoteBtn = document.getElementById('quote-btn');
            // Cart Subtotals
            const cartSubtotalUsd = document.getElementById('cart-subtotal-usd');
            const cartSubtotalBs = document.getElementById('cart-subtotal-bs');
            const cartSubtotalSoloUsdContainer = document.getElementById('cart-subtotal-solo-usd-container');
            const cartSubtotalSoloUsd = document.getElementById('cart-subtotal-solo-usd');
            // Cart Discount
            const discountInput = document.getElementById('discount-input');
            const discountAmountDisplay = document.getElementById('discount-amount-display');
            // Cart Final Totals
            const finalTotalUsd = document.getElementById('final-total-usd');
            const finalTotalBs = document.getElementById('final-total-bs');
            const finalTotalSoloUsdContainer = document.getElementById('final-total-solo-usd-container');
            const finalTotalSoloUsd = document.getElementById('final-total-solo-usd');
            // Gemini
            const geminiRecipeBtn = document.getElementById('gemini-recipe-btn');
            const geminiModal = document.getElementById('gemini-modal');
            const geminiModalTitle = document.getElementById('gemini-modal-title');
            const geminiModalContent = document.getElementById('gemini-modal-content');
            const closeGeminiModal = document.getElementById('close-gemini-modal');

            // App State
            let allData = [];
            let currentStoreProducts = [];
            let cart = [];
            let globalDiscountPercentage = 0;
            let currentStore = '';
            let bcvRate = 0;
            let isPagoUsdActive = false;
            let currentView = 'store-selector'; // 'store-selector', 'catalog', 'special'
            let clientDataForQuote = {};
            
            // --- Gemini API ---
            async function callGeminiApi(prompt) {
                showGeminiModal();
                geminiModalContent.innerHTML = '<div class="loader mx-auto"></div>'; // Show loader

                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // API key is handled by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        geminiModalContent.innerHTML = text.replace(/\n/g, '<br>');
                    } else {
                        throw new Error("Respuesta inesperada de la API.");
                    }
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    geminiModalContent.innerHTML = `<p class="text-red-500">Lo siento, no se pudo obtener una respuesta de la IA en este momento.</p>`;
                }
            }

            function showGeminiModal() { geminiModal.classList.remove('hidden'); }
            function hideGeminiModal() { geminiModal.classList.add('hidden'); }
            closeGeminiModal.addEventListener('click', hideGeminiModal);
            
            geminiRecipeBtn.addEventListener('click', () => {
                if (cart.length === 0) return;
                const productNames = cart.map(item => {
                    const productData = allData.find(p => (p.Producto + ' - ' + (p.Pres || p['Pres.'] || p.Presentacion)) === item.id);
                    return productData ? productData.Producto : '';
                }).filter(Boolean).join(', ');

                const prompt = `Basado en los siguientes productos en un carrito de compras: ${productNames}, sugiere una receta creativa o un plan de comidas. Sé breve y apetitoso.`;
                geminiModalTitle.textContent = "Receta Sugerida por la IA";
                callGeminiApi(prompt);
            });


            // --- Theme Management ---
            function applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            }

            themeMenuButton.addEventListener('click', (event) => {
                event.stopPropagation();
                themeMenu.classList.toggle('hidden');
            });

            document.addEventListener('click', () => {
                if (!themeMenu.classList.contains('hidden')) {
                    themeMenu.classList.add('hidden');
                }
            });

            themeMenu.addEventListener('click', (event) => {
                event.preventDefault();
                const selectedTheme = event.target.dataset.theme;
                if (selectedTheme) {
                    applyTheme(selectedTheme);
                }
            });

            function initializeTheme() {
                const savedTheme = localStorage.getItem('theme') || 'oscuro'; // Default to dark mode
                applyTheme(savedTheme);
            }

            // --- Pago en $ Management ---
            function updatePagoUsdButton() {
                if (isPagoUsdActive) {
                    pagoUsdIconLocked.classList.add('hidden');
                    pagoUsdIconUnlocked.classList.remove('hidden');
                } else {
                    pagoUsdIconLocked.classList.remove('hidden');
                    pagoUsdIconUnlocked.classList.add('hidden');
                }
            }
            
            function initializePagoUsd() {
                const savedState = sessionStorage.getItem('pagoUsdActive');
                isPagoUsdActive = savedState === 'true';
                updatePagoUsdButton();
            }

            pagoUsdButton.addEventListener('click', () => {
                if (isPagoUsdActive) {
                    isPagoUsdActive = false;
                    sessionStorage.setItem('pagoUsdActive', 'false');
                    updatePagoUsdButton();
                    renderCurrentView();
                } else {
                    passwordModal.classList.remove('hidden');
                    passwordInput.focus();
                }
            });

            passwordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (passwordInput.value === '314') {
                    isPagoUsdActive = true;
                    sessionStorage.setItem('pagoUsdActive', 'true');
                    updatePagoUsdButton();
                    passwordModal.classList.add('hidden');
                    passwordInput.value = '';
                    passwordError.classList.add('hidden');
                    renderCurrentView();
                } else {
                    passwordError.classList.remove('hidden');
                    passwordInput.value = '';
                }
            });
            
            cancelPasswordBtn.addEventListener('click', () => {
                passwordModal.classList.add('hidden');
                passwordInput.value = '';
                passwordError.classList.add('hidden');
            });
            
            // --- Quantity Modal Management ---
            function showQuantityModal(productId) {
                quantityModal.dataset.productId = productId;
                quantityInput.value = 1;
                quantityModal.classList.remove('hidden');
                quantityInput.focus();
            }

            function hideQuantityModal() {
                quantityModal.classList.add('hidden');
            }

            quantityForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const productId = quantityModal.dataset.productId;
                const quantity = parseInt(quantityInput.value, 10);
                if (productId && quantity > 0) {
                    addToCart(productId, quantity);
                }
                hideQuantityModal();
            });

            cancelQuantityBtn.addEventListener('click', hideQuantityModal);


            // --- Cart Management ---
            function clearCart() {
                cart = [];
                globalDiscountPercentage = 0;
                discountInput.value = 0;
                saveCart();
            }

            function saveCart() {
                const cartData = {
                    items: cart,
                    globalDiscount: globalDiscountPercentage
                };
                sessionStorage.setItem('shoppingCart', JSON.stringify(cartData));
                updateCartBadge();
                renderCart();
            }

            function loadCart() {
                const savedCartData = sessionStorage.getItem('shoppingCart');
                if (savedCartData) {
                    const cartData = JSON.parse(savedCartData);
                    cart = (cartData.items || []).map(item => ({ ...item, discount: item.discount || 0 }));
                    globalDiscountPercentage = cartData.globalDiscount || 0;
                    discountInput.value = globalDiscountPercentage;
                } else {
                    cart = [];
                    globalDiscountPercentage = 0;
                }
                updateCartBadge();
                renderCart();
            }

            function updateCartBadge() {
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                if (totalItems > 0) {
                    cartBadge.textContent = totalItems;
                    cartBadge.classList.remove('hidden');
                } else {
                    cartBadge.classList.add('hidden');
                }
            }

            function addToCart(productId, quantity) {
                const numQuantity = parseInt(quantity, 10);
                if (isNaN(numQuantity) || numQuantity <= 0) return;

                const existingItem = cart.find(item => item.id === productId);
                if (existingItem) {
                    existingItem.quantity += numQuantity;
                } else {
                    const productData = allData.find(p => (p.Producto + ' - ' + (p.Pres || p['Pres.'] || p.Presentacion)) === productId);
                    if(productData) {
                        cart.push({ id: productId, quantity: numQuantity, discount: 0 });
                    }
                }
                saveCart();
            }

            function updateCartQuantity(productId, change) {
                const cartItem = cart.find(item => item.id === productId);
                if (cartItem) {
                    cartItem.quantity += change;
                    if (cartItem.quantity <= 0) {
                        cart = cart.filter(item => item.id !== productId);
                    }
                    saveCart();
                }
            }
            
            function updateIndividualDiscount(productId, discount) {
                const cartItem = cart.find(item => item.id === productId);
                if (cartItem) {
                    cartItem.discount = discount;
                    saveCart();
                }
            }

            function renderCart() {
                cartItemsList.innerHTML = '';
                if (cart.length === 0) {
                    emptyCartMessage.classList.remove('hidden');
                    cartFooter.classList.add('hidden');
                    return;
                }

                emptyCartMessage.classList.add('hidden');
                cartFooter.classList.remove('hidden');

                let subtotalUsd = 0;
                let subtotalSoloUsd = 0;
                let totalIndividualDiscountAmount = 0;
                let isAnyIndividualDiscountApplied = false;

                cart.forEach(item => {
                    const productData = allData.find(p => (p.Producto + ' - ' + (p.Pres || p['Pres.'] || p.Presentacion)) === item.id);
                    if (!productData) return;

                    const itemSubtotalUsd = Number(productData['Precio $']) * item.quantity;
                    const itemSubtotalSoloUsd = Number(productData['Precio $ con Desc']) * item.quantity;
                    
                    subtotalUsd += itemSubtotalUsd;
                    subtotalSoloUsd += itemSubtotalSoloUsd;

                    const itemDiscountAmount = itemSubtotalUsd * (item.discount / 100);
                    totalIndividualDiscountAmount += itemDiscountAmount;

                    if (item.discount > 0) {
                        isAnyIndividualDiscountApplied = true;
                    }
                    
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex flex-col py-2 border-b border-theme-border';
                    itemElement.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex-grow">
                                <p class="font-semibold text-theme-text-primary">${productData.Producto}</p>
                                <p class="text-sm text-theme-text-secondary">${productData.Pres || productData['Pres.'] || productData.Presentacion}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button data-product-id="${item.id}" data-change="-1" class="quantity-change h-8 w-8 rounded-full bg-theme-surface-secondary text-theme-text-primary">-</button>
                                <span>${item.quantity}</span>
                                <button data-product-id="${item.id}" data-change="1" class="quantity-change h-8 w-8 rounded-full bg-theme-surface-secondary text-theme-text-primary">+</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-end gap-2 mt-2">
                            <label class="text-xs text-theme-text-secondary">Desc. %:</label>
                            <input type="number" data-product-id="${item.id}" value="${item.discount}" min="0" max="10" step="0.1" class="individual-discount-input w-20 p-1 border border-theme-border rounded-md bg-theme-surface text-theme-text-primary text-right">
                        </div>
                    `;
                    cartItemsList.appendChild(itemElement);
                });

                // --- Discount Logic ---
                let finalDiscountAmount = 0;
                if (isAnyIndividualDiscountApplied) {
                    discountInput.disabled = true;
                    discountInput.value = 0;
                    globalDiscountPercentage = 0;
                    finalDiscountAmount = totalIndividualDiscountAmount;
                } else {
                    discountInput.disabled = false;
                    finalDiscountAmount = subtotalUsd * (globalDiscountPercentage / 100);
                }

                const finalUsd = subtotalUsd - finalDiscountAmount;
                const finalBs = finalUsd * bcvRate;
                const finalSoloUsdValue = subtotalSoloUsd - (subtotalSoloUsd * (finalDiscountAmount / subtotalUsd));


                // Update Subtotals
                cartSubtotalUsd.textContent = formatNumber(subtotalUsd);
                cartSubtotalBs.textContent = bcvRate > 0 ? formatNumber(subtotalUsd * bcvRate) : '0.00';
                
                // Update Discount
                discountAmountDisplay.textContent = `- ${formatNumber(finalDiscountAmount)} US$`;

                // Update Final Totals
                finalTotalUsd.textContent = formatNumber(finalUsd);
                finalTotalBs.textContent = bcvRate > 0 ? formatNumber(finalBs) : '0.00';
                
                if (isPagoUsdActive) {
                    cartSubtotalSoloUsdContainer.classList.remove('hidden');
                    cartSubtotalSoloUsd.textContent = formatNumber(subtotalSoloUsd);
                    finalTotalSoloUsdContainer.classList.remove('hidden');
                    finalTotalSoloUsd.textContent = formatNumber(finalSoloUsdValue);
                } else {
                    cartSubtotalSoloUsdContainer.classList.add('hidden');
                    finalTotalSoloUsdContainer.classList.add('hidden');
                }
            }

            cartButton.addEventListener('click', () => {
                cartModal.classList.remove('hidden');
                setTimeout(() => {
                    cartPanel.classList.remove('translate-x-full');
                }, 10);
            });

            closeCartButton.addEventListener('click', () => {
                cartPanel.classList.add('translate-x-full');
                setTimeout(() => {
                    cartModal.classList.add('hidden');
                }, 300);
            });
            
            cartItemsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('quantity-change')) {
                    const productId = e.target.dataset.productId;
                    const change = parseInt(e.target.dataset.change, 10);
                    updateCartQuantity(productId, change);
                }
            });
            
            cartItemsList.addEventListener('input', (e) => {
                if (e.target.classList.contains('individual-discount-input')) {
                    const productId = e.target.dataset.productId;
                    let discount = parseFloat(e.target.value);
                    if (isNaN(discount) || discount < 0) discount = 0;
                    if (discount > 10) discount = 10;
                    e.target.value = discount;
                    updateIndividualDiscount(productId, discount);
                }
            });


            // --- Data Fetching ---
            async function fetchData() {
                loader.style.display = 'flex';
                catalogContainer.style.display = 'none';
                storeSelectorContainer.style.display = 'none';
                errorMessage.style.display = 'none';
                try {
                    const response = await fetch(API_URL);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const responseData = await response.json();
                    
                    if (responseData && Array.isArray(responseData.data)) allData = responseData.data;
                    else if (Array.isArray(responseData)) allData = responseData;
                    else throw new Error("La respuesta de la API no tiene el formato esperado.");

                    // Filter out products without a valid price
                    allData = allData.filter(p => p['Precio $'] && Number(p['Precio $']) > 0);

                    renderStoreSelector();
                } catch (error) {
                    console.error("Failed to fetch data:", error);
                    errorMessage.innerHTML = `<p class="text-red-500 font-semibold">Error al cargar datos.</p>`;
                    errorMessage.style.display = 'block';
                } finally {
                    loader.style.display = 'none';
                }
            }

            // --- View Management ---
            function showView(viewName) {
                currentView = viewName;
                storeSelectorContainer.style.display = 'none';
                catalogContainer.style.display = 'none';
                specialViewContainer.style.display = 'none';

                if (viewName === 'store-selector') {
                    storeSelectorContainer.style.display = 'block';
                    headerTitle.textContent = 'Catálogo';
                    headerTitle.classList.remove('hidden');
                    headerLogo.classList.add('hidden');
                    searchContainer.classList.add('hidden');
                } else if (viewName === 'catalog') {
                    catalogContainer.style.display = 'block';
                    searchContainer.classList.remove('hidden');
                } else if (viewName === 'special') {
                    specialViewContainer.style.display = 'block';
                    searchContainer.classList.add('hidden');
                }
            }
            
            function renderCurrentView() {
                if(currentView === 'catalog') renderProducts();
                else if(currentView === 'special') renderSpecialView();
                renderCart();
            }

            // --- Rendering Functions ---
            function renderStoreSelector() {
                if (!Array.isArray(allData)) {
                    errorMessage.innerHTML = `<p class="text-red-500 font-semibold">Error: Datos no válidos.</p>`;
                    errorMessage.style.display = 'block';
                    return;
                }
                
                const stores = [...new Set(allData.map(item => item.Tienda))].filter(Boolean); 
                storeList.innerHTML = ''; 

                if (stores.length === 0) {
                    errorMessage.innerHTML = `<p class="text-yellow-600 font-semibold">No se encontraron tiendas.</p>`;
                    errorMessage.style.display = 'block';
                    storeSelectorContainer.style.display = 'none';
                    return;
                }

                stores.forEach(store => {
                    const button = document.createElement('button');
                    
                    if (storeImageMap[store]) {
                        button.className = "bg-theme-surface rounded-lg shadow-md hover:shadow-xl hover:-translate-y-1 transition-all flex justify-center items-center h-32 overflow-hidden p-2 w-full max-w-md";
                        button.innerHTML = `<img src="${storeImageMap[store]}" alt="${store}" class="h-full w-full object-contain">`;
                    } else {
                        button.className = "bg-theme-surface p-4 rounded-lg shadow-md hover:shadow-xl hover:-translate-y-1 transition-all text-lg font-semibold text-theme-text-primary flex justify-center items-center h-32 w-full max-w-md";
                        button.textContent = store;
                    }
                    
                    button.addEventListener('click', () => selectStore(store));
                    storeList.appendChild(button);
                });
                showView('store-selector');
            }
            
            function formatNumber(value, minDigits = 2, maxDigits = 2) {
                return new Intl.NumberFormat('es-ES', {
                    minimumFractionDigits: minDigits,
                    maximumFractionDigits: maxDigits
                }).format(value);
            }

            function renderProducts() {
                if (bcvRate <= 0) return;

                const filters = {
                    Menu: filterMenu.value,
                    Tipo: filterTipo.value,
                    Pres: filterPres.value
                };
                const searchTerm = searchBar.value.toLowerCase();

                let baseFiltered = currentStoreProducts;

                if (searchTerm) {
                    baseFiltered = baseFiltered.filter(p => p.Producto.toLowerCase().includes(searchTerm));
                }

                let filteredByMenuAndTipo = baseFiltered.filter(product => 
                    (filters.Menu === 'all' || product.Menu === filters.Menu) &&
                    (filters.Tipo === 'all' || product.Tipo === filters.Tipo)
                );
                
                productList.innerHTML = ''; 
                noResults.style.display = 'none';

                if (filters.Pres === 'all') {
                    const groupedProducts = filteredByMenuAndTipo.reduce((acc, product) => {
                        const productName = product.Producto;
                        if (!acc[productName]) acc[productName] = [];
                        acc[productName].push(product);
                        return acc;
                    }, {});

                    if (Object.keys(groupedProducts).length === 0) {
                        noResults.style.display = 'block';
                        return;
                    }

                    for (const productName in groupedProducts) {
                        const presentations = groupedProducts[productName];
                        const firstPresentation = presentations[0];
                        const card = document.createElement('div');
                        card.className = "bg-theme-surface rounded-lg shadow-md overflow-hidden flex flex-col";
                        const placeholderImg = `https://placehold.co/400x400/e2e8f0/4a5568?text=${encodeURIComponent(productName)}`;
                        
                        const tableHeaderPagoUsd = isPagoUsdActive ? `<th class="py-2 px-3 text-right text-xs font-bold uppercase text-theme-accent">SOLO $</th>` : '';
                        
                        const tableRows = presentations.map(p => {
                            const presValue = p.Pres || p['Pres.'] || p.Presentacion || '';
                            const priceRegular = Number(p['Precio $']);
                            const priceDesc = Number(p['Precio $ con Desc']);
                            const localPrice = bcvRate > 0 ? formatNumber(priceRegular * bcvRate) : '';
                            const pagoUsdCell = isPagoUsdActive ? `<td class="py-2 px-3 text-base font-bold text-theme-accent text-right">${formatNumber(priceDesc)}</td>` : '';
                            const productId = p.Producto + ' - ' + presValue;
                            
                            return `<tr class="border-b border-theme-border last:border-b-0">
                                        <td class="py-2 px-3 text-sm text-theme-text-primary">${presValue}</td>
                                        <td class="py-2 px-3 text-sm text-theme-text-primary text-right">${formatNumber(priceRegular)}</td>
                                        <td class="py-2 px-3 text-sm text-theme-text-primary text-right">${localPrice}</td>
                                        ${pagoUsdCell}
                                        <td class="py-2 px-3 text-right"><button data-product-id="${productId}" class="add-to-cart-btn bg-theme-accent text-theme-accent-text h-7 w-7 rounded-full">+</button></td>
                                    </tr>`;
                        }).join('');
                        
                        card.innerHTML = `<img src="${firstPresentation.Images || placeholderImg}" alt="${productName}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='${placeholderImg}';">
                                        <div class="p-4 flex flex-col flex-grow">
                                            <div class="flex items-center justify-between mb-3">
                                                <h3 class="text-lg font-semibold text-theme-text-primary">${productName}</h3>
                                                <button class="gemini-description-btn p-1 text-theme-text-secondary hover:text-theme-accent" data-product-name="${productName}">
                                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                                                </button>
                                            </div>
                                            <div class="w-full overflow-x-auto no-scrollbar">
                                                <table class="min-w-full bg-theme-surface-secondary rounded-lg">
                                                    <thead><tr class="bg-theme-bg"><th class="py-2 px-3 text-left text-xs font-bold uppercase text-theme-text-secondary">PRES.</th><th class="py-2 px-3 text-right text-xs font-bold uppercase text-theme-text-secondary">US$</th><th class="py-2 px-3 text-right text-xs font-bold uppercase text-theme-text-secondary">Bs.</th>${tableHeaderPagoUsd}<th class="w-10"></th></tr></thead>
                                                    <tbody>${tableRows}</tbody>
                                                </table>
                                            </div>
                                        </div>`;
                        productList.appendChild(card);
                    }
                } else {
                    const filteredProducts = filteredByMenuAndTipo.filter(product => {
                        const presentationValue = product.Pres || product['Pres.'] || product.Presentacion;
                        return presentationValue === filters.Pres;
                    });
                    if (filteredProducts.length === 0) {
                        noResults.style.display = 'block';
                        return;
                    }
                    filteredProducts.forEach(product => {
                        const card = document.createElement('div');
                        card.className = "bg-theme-surface rounded-lg shadow-md overflow-hidden flex flex-col transition-all hover:shadow-lg";
                        const placeholderImg = `https://placehold.co/400x400/e2e8f0/4a5568?text=${encodeURIComponent(product.Producto)}`;
                        const presValue = product.Pres || product['Pres.'] || product.Presentacion || '';
                        const priceRegular = Number(product['Precio $']);
                        const priceDesc = Number(product['Precio $ con Desc']);
                        const localPrice = bcvRate > 0 ? formatNumber(priceRegular * bcvRate) : '';
                        const pagoUsdHtml = isPagoUsdActive ? `<p class="text-theme-accent text-xl font-bold">SOLO $: ${formatNumber(priceDesc)}</p>` : '';
                        const productId = product.Producto + ' - ' + presValue;

                        card.innerHTML = `<img src="${product.Images || placeholderImg}" alt="${product.Producto}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='${placeholderImg}';">
                                        <div class="p-4 flex flex-col flex-grow">
                                            <div class="flex items-center justify-between mb-2">
                                                <h3 class="text-lg font-semibold text-theme-text-primary flex-grow">${product.Producto}</h3>
                                                <button class="gemini-description-btn p-1 text-theme-text-secondary hover:text-theme-accent" data-product-name="${product.Producto}">
                                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                                                </button>
                                            </div>
                                            <div class="mt-auto space-y-1">
                                                <p class="text-theme-text-secondary font-medium">${presValue}</p>
                                                <p class="text-theme-text-secondary text-sm">US$: ${formatNumber(priceRegular)}</p>
                                                <p class="text-theme-text-secondary font-medium">Bs.: ${localPrice}</p>
                                                ${pagoUsdHtml}
                                            </div>
                                            <button data-product-id="${productId}" class="add-to-cart-btn mt-4 w-full bg-theme-accent text-theme-accent-text py-2 rounded-lg">Añadir al Carrito</button>
                                        </div>`;
                        productList.appendChild(card);
                    });
                }
            }
            
            // --- Special View Functions ---
            function renderSpecialView() {
                if (bcvRate <= 0) {
                    specialProductTable.innerHTML = '';
                    return;
                }
                
                const tipo = filterTipoSpecial.value;
                const pres = filterPresSpecial.value;

                let filtered = currentStoreProducts;

                if (tipo) {
                    filtered = filtered.filter(p => p.Tipo === tipo);
                }
                if (pres) {
                    filtered = filtered.filter(p => (p.Pres || p['Pres.'] || p.Presentacion) === pres);
                }
                
                // Sort by Precio $ descending
                filtered.sort((a, b) => Number(b['Precio $']) - Number(a['Precio $']));
                
                specialProductTable.innerHTML = '';
                if (filtered.length === 0) {
                    specialProductTable.innerHTML = `<p class="text-theme-text-secondary text-center">No hay productos para esta selección.</p>`;
                    return;
                }

                const tableHeaderPagoUsd = isPagoUsdActive ? `<th class="p-2 text-right text-xs font-bold uppercase text-theme-accent">SOLO $</th>` : '';
                const tableHeader = `<table class="w-full text-left">
                                        <thead><tr class="border-b border-theme-border">
                                            <th class="p-2 w-16"></th>
                                            <th class="p-2 text-xs font-bold uppercase text-theme-text-secondary">Producto</th>
                                            <th class="p-2 text-right text-xs font-bold uppercase text-theme-text-secondary">US$</th>
                                            <th class="p-2 text-right text-xs font-bold uppercase text-theme-text-secondary">Bs.</th>
                                            ${tableHeaderPagoUsd}
                                            <th class="w-10"></th>
                                        </tr></thead><tbody>`;
                
                const tableRows = filtered.map(p => {
                    const presValue = p.Pres || p['Pres.'] || p.Presentacion || '';
                    const priceRegular = Number(p['Precio $']);
                    const priceDesc = Number(p['Precio $ con Desc']);
                    const localPrice = bcvRate > 0 ? formatNumber(priceRegular * bcvRate) : '';
                    const pagoUsdCell = isPagoUsdActive ? `<td class="p-2 text-right font-bold text-theme-accent">${formatNumber(priceDesc)}</td>` : '';
                    const productId = p.Producto + ' - ' + presValue;
                    const placeholderImg = `https://placehold.co/100x100/e2e8f0/4a5568?text=${encodeURIComponent(p.Producto.charAt(0))}`;

                    return `<tr class="border-b border-theme-border last:border-b-0">
                                <td class="p-2"><img src="${p.Images || placeholderImg}" class="h-12 w-12 object-cover rounded-md" onerror="this.onerror=null;this.src='${placeholderImg}';"></td>
                                <td class="p-2 text-sm text-theme-text-primary"><div class="line-clamp-2">${p.Producto}</div><div class="text-xs text-theme-text-secondary">${presValue}</div></td>
                                <td class="p-2 text-right text-sm text-theme-text-primary">${formatNumber(priceRegular)}</td>
                                <td class="p-2 text-right text-sm text-theme-text-primary">${localPrice}</td>
                                ${pagoUsdCell}
                                <td class="p-2 text-right"><button data-product-id="${productId}" class="add-to-cart-btn bg-theme-accent text-theme-accent-text h-7 w-7 rounded-full">+</button></td>
                            </tr>`;
                }).join('');

                specialProductTable.innerHTML = tableHeader + tableRows + '</tbody></table>';
            }

            function populateSpecialFilters() {
                const tipos = ["Caucho mate", "Caucho satinado", "Esmalte brillante"];
                filterTipoSpecial.innerHTML = tipos.map(t => `<option value="${t}">${t}</option>`).join('');
                updateSpecialPresFilter();
            }

            function updateSpecialPresFilter() {
                const selectedTipo = filterTipoSpecial.value;
                const relevantProducts = currentStoreProducts.filter(p => p.Tipo === selectedTipo);
                const presentations = [...new Set(relevantProducts.map(p => p.Pres || p['Pres.'] || p.Presentacion).filter(Boolean))];
                filterPresSpecial.innerHTML = presentations.map(p => `<option value="${p}">${p}</option>`).join('');
                renderSpecialView();
            }
            
            // --- Filter Population ---
            function updatePresFilter() {
                const selectedMenu = filterMenu.value;
                const selectedTipo = filterTipo.value;
                const currentPres = filterPres.value;

                let relevantProducts = currentStoreProducts;
                if (selectedMenu !== 'all') {
                    relevantProducts = relevantProducts.filter(p => p.Menu === selectedMenu);
                }
                if (selectedTipo !== 'all') {
                    relevantProducts = relevantProducts.filter(p => p.Tipo === selectedTipo);
                }
                
                const presentations = ['Todas las Presentaciones', ...new Set(relevantProducts.map(p => p.Pres || p['Pres.'] || p.Presentacion).filter(Boolean))];
                populateSelect(filterPres, presentations);

                if (presentations.includes(currentPres)) {
                    filterPres.value = currentPres;
                } else {
                    filterPres.value = 'all';
                }
            }

            function updateTipoFilter() {
                const selectedMenu = filterMenu.value;
                const currentTipo = filterTipo.value;

                const relevantProducts = selectedMenu === 'all' 
                    ? currentStoreProducts 
                    : currentStoreProducts.filter(p => p.Menu === selectedMenu);
                
                const tipos = ['Todos los Tipos', ...new Set(relevantProducts.map(p => p.Tipo).filter(Boolean))];
                populateSelect(filterTipo, tipos);

                if (tipos.includes(currentTipo)) {
                    filterTipo.value = currentTipo;
                } else {
                    filterTipo.value = 'all';
                }
                updatePresFilter(); // Update presentations when tipo changes
            }

            function populateFilters() {
                const menus = ['Todos los Menús', ...new Set(currentStoreProducts.map(p => p.Menu).filter(Boolean))];
                populateSelect(filterMenu, menus);
                updateTipoFilter(); // This will also call updatePresFilter
            }
            
            function populateSelect(selectElement, options) {
                selectElement.innerHTML = '';
                options.forEach((option, index) => {
                    const opt = document.createElement('option');
                    opt.value = index === 0 ? 'all' : option;
                    opt.textContent = option;
                    selectElement.appendChild(opt);
                });
            }

            function selectStore(storeName) {
                currentStore = storeName;
                currentStoreProducts = allData.filter(item => item.Tienda === storeName);
                
                if (storeImageMap[storeName]) {
                    headerLogo.src = storeImageMap[storeName];
                    headerLogo.alt = `Logo ${storeName}`;
                    headerLogo.classList.remove('hidden');
                    headerTitle.classList.add('hidden');
                } else {
                    headerTitle.textContent = storeName;
                    headerTitle.classList.remove('hidden');
                    headerLogo.classList.add('hidden');
                }
                
                showView('catalog');
                populateFilters();
            }
            
            // --- Event Listeners ---
            function handleBcvInput(e) {
                let inputValue = e.target.value;

                // Sanitize input: allow numbers, one comma or one dot.
                inputValue = inputValue.replace(/[^0-9.,]/g, '').replace(/,/g, '.');
                
                const parts = inputValue.split('.');
                if (parts.length > 2) {
                    inputValue = parts[0] + '.' + parts.slice(1).join('');
                }

                // Update the input field with the sanitized value
                e.target.value = inputValue;

                // Sync both input fields
                if (e.target.id === 'bcv-rate') {
                    bcvRateInputSpecial.value = inputValue;
                } else {
                    bcvRateInput.value = inputValue;
                }

                const rate = parseFloat(inputValue);

                if (rate > 0) {
                    bcvRate = rate;
                    catalogContent.classList.remove('hidden');
                    specialCatalogContent.classList.remove('hidden');
                    renderCurrentView();
                } else {
                    bcvRate = 0;
                    catalogContent.classList.add('hidden');
                    specialCatalogContent.classList.add('hidden');
                }
            }
            bcvRateInput.addEventListener('input', handleBcvInput);
            bcvRateInputSpecial.addEventListener('input', handleBcvInput);

            specialViewButton.addEventListener('click', () => {
                showView('special');
                populateSpecialFilters();
            });
            backToCatalogButton.addEventListener('click', () => showView('catalog'));

            productList.addEventListener('click', (e) => {
                const descBtn = e.target.closest('.gemini-description-btn');
                const cartBtn = e.target.closest('.add-to-cart-btn');
                if (descBtn) { 
                    const productName = descBtn.dataset.productName;
                    const productData = currentStoreProducts.find(p => p.Producto === productName);

                    if (productData) {
                        let prompt;
                        if (productData.descripcion_ia && productData.descripcion_ia.trim() !== '') {
                            prompt = `Actúa como un experto en ventas. Basado en la siguiente información: '${productData.descripcion_ia}', redacta un único argumento de venta convincente y orientado a los beneficios para un cliente. El texto debe tener aproximadamente 50 palabras y ser un solo párrafo.`;
                        } else {
                            prompt = `Actúa como un experto en ventas. Genera un único argumento de venta convincente y orientado a los beneficios para el siguiente producto: Nombre: ${productData.Producto}, Categoría: ${productData.Menu}, Tipo: ${productData.Tipo}. El texto debe tener aproximadamente 50 palabras y ser un solo párrafo.`;
                        }
                        geminiModalTitle.textContent = `Argumento de Venta para ${productName}`;
                        callGeminiApi(prompt);
                    }
                }
                if (cartBtn) { 
                    showQuantityModal(cartBtn.dataset.productId); 
                }
            });
            
            specialProductTable.addEventListener('click', (e) => {
                const cartBtn = e.target.closest('.add-to-cart-btn');
                if (cartBtn) { 
                    showQuantityModal(cartBtn.dataset.productId); 
                }
            });

            searchBar.addEventListener('input', renderProducts);
            filterMenu.addEventListener('change', () => { updateTipoFilter(); renderProducts(); });
            filterTipo.addEventListener('change', () => { updatePresFilter(); renderProducts(); });
            filterPres.addEventListener('change', renderProducts);
            filterTipoSpecial.addEventListener('change', updateSpecialPresFilter);
            filterPresSpecial.addEventListener('change', renderSpecialView);
            
            clearCartBtn.addEventListener('click', () => {
                confirmationMessage.textContent = '¿Estás seguro que deseas vaciar el carrito?';
                confirmActionBtn.dataset.action = 'clearCart';
                confirmationModal.classList.remove('hidden');
            });
            
            discountInput.addEventListener('input', (e) => {
                let value = parseFloat(e.target.value);
                if (isNaN(value) || value < 0) {
                    value = 0;
                }
                if (value > 10) {
                    value = 10;
                }
                e.target.value = value;
                globalDiscountPercentage = value;
                saveCart();
            });

            // --- Quote / PDF Generation ---
            quoteBtn.addEventListener('click', () => {
                if (cart.length > 0) {
                    clientInfoModal.classList.remove('hidden');
                }
            });

            cancelClientInfoBtn.addEventListener('click', () => {
                clientInfoModal.classList.add('hidden');
            });

            clientInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
                clientDataForQuote = {
                    name: document.getElementById('client-name').value,
                    rif: document.getElementById('client-rif').value,
                    phone: document.getElementById('client-phone').value,
                    email: document.getElementById('client-email').value,
                };
                clientInfoModal.classList.add('hidden');
                
                confirmationMessage.textContent = '¿Generar cotización en PDF?';
                confirmActionBtn.dataset.action = 'generatePDF';
                confirmationModal.classList.remove('hidden');
            });

            confirmActionBtn.addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                if (action === 'clearCart') {
                    clearCart();
                } else if (action === 'generatePDF') {
                    generateQuotePDF(clientDataForQuote);
                }
                confirmationModal.classList.add('hidden');
            });

            cancelActionBtn.addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
            });

            function generateQuotePDF(clientData) {
                const doc = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: 'letter'
                });

                // --- Calculate totals again for PDF ---
                let subtotalUsd = 0;
                let totalIndividualDiscountAmount = 0;
                const isAnyIndividualDiscountApplied = cart.some(item => item.discount > 0);

                const tableBody = cart.map(item => {
                    const productData = allData.find(p => (p.Producto + ' - ' + (p.Pres || p['Pres.'] || p.Presentacion)) === item.id);
                    if (!productData) return null; // Failsafe
                    
                    const itemSubtotal = Number(productData['Precio $']) * item.quantity;
                    subtotalUsd += itemSubtotal;
                    const itemDiscount = itemSubtotal * (item.discount / 100);
                    totalIndividualDiscountAmount += itemDiscount;

                    return [
                        item.quantity,
                        `${productData.Producto} - ${productData.Pres || productData['Pres.'] || productData.Presentacion}`,
                        formatNumber(productData['Precio $']),
                        formatNumber(itemSubtotal - itemDiscount)
                    ];
                }).filter(Boolean); // Remove nulls if a product wasn't found

                const finalDiscountAmount = isAnyIndividualDiscountApplied ? totalIndividualDiscountAmount : subtotalUsd * (globalDiscountPercentage / 100);
                const finalTotal = subtotalUsd - finalDiscountAmount;
                
                // --- PDF Content ---
                const today = new Date();
                const dateStr = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;
                const quoteNumber = `COT-${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}-${Date.now().toString().slice(-4)}`;

                // Header
                doc.setFontSize(18);
                doc.text(currentStore, 14, 22);
                doc.setFontSize(11);
                doc.text("COTIZACIÓN", 200, 22, { align: 'right' });
                doc.line(14, 25, 200, 25);

                // Info
                doc.setFontSize(10);
                doc.text(`Fecha: ${dateStr}`, 200, 32, { align: 'right' });
                doc.text(`Número: ${quoteNumber}`, 200, 37, { align: 'right' });
                
                // Client Info
                doc.setFontSize(12);
                doc.text("Cliente:", 14, 40);
                doc.setFontSize(10);
                doc.text(clientData.name, 14, 46);
                doc.text(`RIF: ${clientData.rif}`, 14, 51);
                doc.text(`Tel: ${clientData.phone}`, 14, 56);
                doc.text(`Email: ${clientData.email}`, 14, 61);

                // Table
                doc.autoTable({
                    startY: 70,
                    head: [['Cant.', 'Descripción', 'P.U. (US$)', 'Total (US$)']],
                    body: tableBody,
                    headStyles: { fillColor: [31, 41, 55] }, // gray-800
                    theme: 'striped',
                    styles: { cellPadding: 2.5, fontSize: 9 },
                    didDrawPage: function (data) {
                        // Footer
                        const pageCount = doc.internal.getNumberOfPages();
                        doc.setFontSize(8);
                        doc.text('Página ' + String(data.pageNumber) + ' de ' + pageCount, data.settings.margin.left, 270);
                    }
                });
                
                // Totals
                const finalY = doc.autoTable.previous.finalY;
                doc.setFontSize(10);
                doc.text('Subtotal:', 150, finalY + 10, { align: 'right' });
                doc.text(`${formatNumber(subtotalUsd)} US$`, 200, finalY + 10, { align: 'right' });
                doc.text('Descuento:', 150, finalY + 15, { align: 'right' });
                doc.text(`- ${formatNumber(finalDiscountAmount)} US$`, 200, finalY + 15, { align: 'right' });
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL A PAGAR:', 150, finalY + 22, { align: 'right' });
                doc.text(`${formatNumber(finalTotal)} US$`, 200, finalY + 22, { align: 'right' });

                // Final notes
                doc.setFontSize(8);
                doc.setFont('helvetica', 'italic');
                doc.text('Precios sujetos a cambio. Cotización válida por 24 horas.', 14, 265);

                doc.save(`Cotizacion_${clientData.name.replace(/ /g, '_')}_${quoteNumber}.pdf`);
            }

            // --- Initializers ---
            initializeTheme();
            initializePagoUsd();
            loadCart();
            fetchData();
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>
